json = render partial: "user.json.jb", locals: { user: @user }

if current_user == @user || current_user.friends.include?(@user)
  json[:friends] = true
  json[:items] = @user.items.map do |item|
    item_json = render partial: "api/items/item.json.jb", locals: { item: item }
    item_json[:category] = render partial: "api/categories/category.json.jb", locals: { category: item.category }
    item_json
  end
else
  json[:friends] = false
end

json